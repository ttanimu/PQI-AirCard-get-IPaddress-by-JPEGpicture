# PQI-AirCard-get-IPaddress-by-JPEGpicture
When you use PQI's AirCard + digital camera,
you can know the IP address of AirCard by viewing the JPEG picture generated by this app.
That picture includes that IP address and is generated on the server.

PQI社のAirCardをデジカメに差し込んで利用する際に
AirCardがDHCPサーバから割り振られたIPアドレスが書かれたJPEG画像を生成し、
デジカメでその画像を再生することでIPアドレスを確認できるようにする。
ただし画像の生成のためにサーバが必要。

---

## How to modify the firmware
Open [PQIのダウンロードページ](http://jp.pqigroup.com/prod_driver.aspx?mnuid=1296&modid=145&prodid=500) and
click [Air Cardファームウェア_V147](http://jp.pqigroup.com/driver_download.aspx?mnuid=1296&modid=145&prodid=500&driverId=250)(Japanese version) to get "20130204092611001.zip".
And click [ファームウェア更新手順](http://jp.pqigroup.com/driver_download.aspx?mnuid=1296&modid=145&prodid=500&driverId=251)(Japanese version) to get "20130204092726001.pdf".
Extract "20130204092611001.zip" and get "initramfs3.gz".
Remove head's 8 byte of "initramfs3.gz" by binary editor.
The first 4 bytes of this 8 byte are Magic number "KAGZ"({0x4b,0x41,0x47,0x5a}),
and the last 4 bytes are the size of payload(big endian).
You must do the following operations to the reduced "initramfs3.gz" on Linux as root user.
Run the following commands.
<pre>
# gunzip initramfs3.gz
# mkdir aircard
# cd aircard
# cpio -i &lt; ../initramfs3
</pre>
There are rootfs on "aircard" directory. Repackage them after modifying by the following command.
<pre>
# find . | cpio --create --format='newc' | gzip &gt; ../initramfs3.gz
</pre>
Added the 8 bytes header to "initramfs3.gz" repackaged.
(The first 4 bytes of this 8 byte are Magic number "KAGZ"({0x4b,0x41,0x47,0x5a}),
and the last 4 bytes are the size of payload(big endian).)
Update firmware. See "20130204092726001.pdf"(Japanese version).

## Preparation of server
The following operations are for Debian server on Internet.
The web server (Apache+PHP) works on this server.
Run the following command.
<pre>
# apt-get install imagemagick
</pre>
And run the following command
<pre>
$ convert -geometry &lt;width(pixels)&gt;x&lt;height(pixels)&gt;! -fill &lt;the color of text&gt; -font &lt;TrueType font file(full path)&gt; -pointsize &lt;The size of text(points)&gt; label:&lt;embedded string&gt; &lt;generating JPEG file("*.jpg")&gt;
</pre>
Check that your digital camera can display its JPEG picture.
If it can't, investigate by the following commands and adjust its arguments..
<pre>
# apt-get install jhead
# exit
$ jhead &lt;JPEG file generated&gt;
</pre>
And there are some TrueType font files(*.ttf) on "/usr/share/fonts/truetype" directory.
You can choose one of them.

Copy "/server/var/www/html/ip/index.php" to "/var/www/html/ip/" directory on the server, adjust its permissions and modify it.

After opening the following URL on the web browser.
<pre>
http://&lt;server name&gt;/ip/index.php?ip=<IP address>
</pre>
Open the following URL.
<pre>
http://&lt;server name&gt;/ip/ip.jpg
</pre>
You can see the IP address on the picture.

## Patch for the firmware
Overwrite "aircard_v147/" directory to the rootfs of AirCard, repackage and flash(see the above). 
But you must make sure the original file If you get the other version of firmware.
And you have to replace the string <server name> to server name(or IP address) before overwriting.

## How to use
After removing [green control picture(Connect to Hotspot)] on AirCard and AirCard connect to the Internet,
"WSD00004.JPG" is generated. you can know AirCard's IP address by viewing that picture.
But some digital cameras can't display that picture.
You can open the following URL on the web browser and you can know it.
<pre>
http://&lt;server name&gt;/ip/ip.jpg
</pre>

## Reference URL
https://ttanimu.blogspot.com/2013/02/aircard.html
https://ttanimu.blogspot.com/2013/03/aircardip-1.html
https://ttanimu.blogspot.com/2013/03/aircardip-2-aircard.html

---

## ファームウェア改変方法
[PQIのダウンロードページ](http://jp.pqigroup.com/prod_driver.aspx?mnuid=1296&modid=145&prodid=500)から
[Air Cardファームウェア_V147](http://jp.pqigroup.com/driver_download.aspx?mnuid=1296&modid=145&prodid=500&driverId=250)をクリックして"20130204092611001.zip"をダウンロードする。
また[ファームウェア更新手順](http://jp.pqigroup.com/driver_download.aspx?mnuid=1296&modid=145&prodid=500&driverId=251)をクリックして"20130204092726001.pdf"もダウンロードしておく。
"20130204092611001.zip"を展開し"initramfs3.gz"を取り出す。
"initramfs3.gz"をバイナリエディタで開き先頭の8バイトを削除する(ファイルは8バイト小さくなる)。
なお削除した8バイトの前半4バイトは"KAGZ"({0x4b,0x41,0x47,0x5a})の固定で、
後半4バイトはその後に続くペイロードのサイズをビッグエンディアンで格納している。
以後、サイズの小さくなった"initramfs3.gz"を操作するのだが、作業はすべてLinux(x64)上でroot権限で行う。
以下を実行する。
<pre>
# gunzip initramfs3.gz
# mkdir aircard
# cd aircard
# cpio -i &lt; ../initramfs3
</pre>
aircardディレクトリ内のrootfsを改変した後、以下を実行して再パッケージ化する。
<pre>
# find . | cpio --create --format='newc' | gzip &gt; ../initramfs3.gz
</pre>
その後前述の8バイトのヘッダを付け加えて(前半4バイトは"KAGZ"({0x4b,0x41,0x47,0x5a})の固定で、後半4バイトはその後に続くペイロードのサイズをビッグエンディアンで格納)完了。
その後、先にダウンロードした"20130204092726001.pdf"を参考にファームウェアを書き換える。

## サーバの準備
ここではインターネット上に準備したDebianサーバを例にします。
このサーバではウェブサーバとしてapacheとphpが動作していることを前提とします。
まず以下を実行します。
<pre>
# apt-get install imagemagick
</pre>
次にテストします。
<pre>
$ convert -geometry &lt;横のピクセル数&gt;x&lt;縦のピクセル数&gt;! -fill &lt;文字の色&gt; -font &lt;TrueTypeフォントのファイル名(フルパス)&gt; -pointsize &lt;文字の大きさ(ポイント)&gt; label:&lt;画像に埋め込む文字列&gt; &lt;生成するJPEGファイル名前(拡張子は".jpg")&gt;
</pre>
を実行して使用するデジカメで閲覧可能なjpegファイルが生成できることを確認します。
もし表示できないようなら以下のコマンドで調査して引数を調整してください。
<pre>
# apt-get install jhead
# exit
$ jhead &lt;生成したJPEGファイル&gt;
</pre>
なおTrueTypeフォントのファイルは"/usr/share/fonts/truetype"ディレクトリの下に
拡張子が".ttf"なファイルがあると思うので適当に選んでください。

標準的には"/server/var/www/html/ip/index.php"をサーバの"/var/www/html/ip/"ディレクトリにコピーし、パーミッションを整えた上で、
上記のテストを結果を踏まえて"/var/www/html/ip/index.php"を調整します。

最後に動作テスト。ウェブブラウザから
<pre>
http://&lt;サーバ名&gt;/ip/index.php?ip=<IPアドレス>
</pre>
にアクセスした後で
<pre>
http://&lt;サーバ名&gt;/ip/ip.jpg
</pre>
にアクセスすることでIPアドレスを書き込んだ画像が取得できるはず。

## ファームウェアの変更点
AirCardのrootfsに"aircard_v147/"ディレクトリを上書きして再パッケージし書き込みます。手順は前述の通り。
ただし上書き前に元のファイルの状況を確認して修正が妥当であることを確認ください。
そのままの上書きで問題があるようなら差分を参考に手動で修正ください。
また上書きする前に文字列<server name>を実際のサーバ名(またはIPアドレス)に変更しておく必要があります。

## 使い方
AirCard内の[緑の制御画像(Connect to Hotspot)]を削除して
インターネットにつながったとき"WSD00004.JPG"が生成されるので、
その画像を表示すればIPアドレスがわかります。
ただし、デジカメの機種毎の動作特性により生成された画像が見えないこともあり、
最悪の場合はスマートフォン等のブラウザで
<pre>
http://&lt;サーバ名&gt;/ip/ip.jpg
</pre>
の画像を直接見ることになります。

## 参考URL
https://ttanimu.blogspot.com/2013/02/aircard.html
https://ttanimu.blogspot.com/2013/03/aircardip-1.html
https://ttanimu.blogspot.com/2013/03/aircardip-2-aircard.html
